//================================================================================
// [hypermodel]
// version: 1.0.3
// update: 2016.07.20
//================================================================================

!function(a){var b=[],c=0;a.fn.hypermodel=function(d,e){var f=this,g="init",h=a(window);a(document);"object"!=typeof d&&(g=d,d=e);var i={grad:1.75,time:{animate:300,frame:3e3,highlight:3e3},update:null,strokeSpeed:500,strokeColor:"rgba(192, 192, 192, .6)",strokeHighlightColor:"rgba(200, 206, 255, .6)",strokeHighlightDashColor:"rgba(178, 192, 255, 1)",strokeDashColor:"rgba(192, 192, 192, .95)",strokeWidth:1,strokeHighlightWidth:1,strokeDashWidth:1,strokeDashWeight:8,strokeDashMargin:6};a.extend(i,d);var j={offset:{t:20,r:10,b:20,l:10,d:.5,g:1},placeholder:{size:600}},k=a(this).addClass("hypermodel-wrapper"),l=null,m=!0,n=null,o=window.getSelection?window.getSelection():document.selection?document.selection:null,p=function(a,b){return Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2))},q=function(){r.apply(this,Array.prototype.slice.call(arguments))},r=function(){h.triggerHandler("resize.hypermodelHandler")},s=function(b){var c=a(this);k.disableSelection(),c.sortable({items:".hypermodel-grid",handle:".hypermodel-header",change:q,out:r,containment:"body",tolerance:"pointer",dropOnEmpty:!0,axis:"y",scroll:!0,beforeStop:function(b,c){var d=a(this),e=d.children(":last"),f=e.position().top,g=c.position.top,h=c.item.height();g+2*h>f&&e.insertBefore(c.item)},start:function(a,b){b.placeholder.height(b.item.height()),b.item.data("sortable-idx",b.item.index())},update:function(a,b){"function"==typeof i.update&&i.update.apply(this,Array.prototype.slice.call(arguments))},stop:function(){f.hypermodel("repaint")}})};switch(g){case"init":return b=[],this.each(function(){k.css("position","relative").bind("click",function(a){o&&(o.empty?o.empty():o.removeAllRanges())}),k.find(".hypermodel-column .hypermodel-grid").bind("click",function(b){b.stopPropagation();a(this)}).find(".hypermodel-item").bind("click",function(b){b.stopPropagation();a(this)}),h.unbind("resize.hypermodelHandler init.hypermodelHandler").bind("resize.hypermodelHandler init.hypermodelHandler",function(d){try{var e=0;k.find(".hypermodel-column").each(function(){var b=a(this);e+=b.outerWidth(!0)}),k.find(".hypermodel-area").outerWidth(parseInt(e+1));var f={t:k.offset().top,l:k.offset().left},g={t:parseInt(k.css("padding-top").replace(/[^\d]+/,"")||0),l:parseInt(k.css("padding-left").replace(/[^\d]+/,"")||0)},h=0,o=0;try{h=k.parent()[0].scrollWidth-2*g.l,o=k.parent()[0].scrollHeight-2*g.t}catch(q){return!1}"init"==d.type?(a(".hyper-model-canvas").remove(),n=Raphael(0,0,h,o),n.canvas.setAttribute("class","hyper-model-canvas"),l=a(n.canvas),a(n.canvas).appendTo(k).css({left:0+g.l,top:0+g.t})):l.attr({width:h,height:o});var r=a('<style class="hyper-model-anim"></style>');a(".hyper-model-anim").remove(),a("head").append(r);var s="";k.find(".hypermodel-grid, .hypermodel-item").unbind("click.hypermodelHandler").bind("click.hypermodelHandler",function(b){b.stopPropagation();a(this)}).each(function(){var e=a(this);if("undefined"==typeof e.data("target")||""===e.data("target"))return!0;var h={t:e.offset().top+j.offset.d-j.offset.g+j.offset.t-f.t-g.t,r:e.offset().left+e.outerWidth()+j.offset.d-j.offset.g-f.l-g.l,b:e.offset().top+e.outerHeight()+j.offset.d-j.offset.g-f.t-g.t,l:e.offset().left+j.offset.d-j.offset.g-f.l-g.l},k="",l=e.data("target").toString().split(","),o={x:0,y:0},q={x:0,y:0};"undefined"!=typeof e.attr("id")&&null!==e.attr("id")&&(k=e.attr("id").replace(/.*model-[nc](\d+).*/,"$1"),"undefined"!=typeof k&&""!==k&&(k=parseInt(k)));for(var r in l){var t=a.trim(l[r]),u=k+"->"+t,v=e.data("highlight")?e.data("highlight").split(","):"";for(var w in v){var x=v[w];v[w]=k+"->"+x}var y=a("#model-n"+t).filter(":visible").not(".ui-sortable-helper");if(y.length<=0||y.is(":hidden")||y.hasClass("ui-sortable-helper")){for(var z in b[u])try{b[u][z].remove()}catch(A){console.log(A)}delete b[u]}else{var B={t:y.offset().top+j.offset.d+j.offset.t-f.t-g.t,r:y.offset().left+y.outerWidth()+j.offset.d-f.l-g.l,b:y.offset().top+y.outerHeight()+j.offset.d-f.t-g.t,l:y.offset().left+j.offset.d-f.l-g.l};o.x=h.r,o.y=h.t,q.x=B.l,q.y=B.t;var C="",D=p(o,q);if(C+=" M "+h.r+" "+h.t,h.t!==B.t&&m===!0){var E=Math.abs(h.r-B.l)/(1*i.grad),F=Math.abs(h.t-B.t)/100;C+=" C "+(h.r+E)+" "+(h.t+F)+" "+(B.l-E)+" "+(B.t-F)+" "}else C+=" L ";if(C+=B.l+" "+B.t,s+="@keyframes keyframe-dash-i"+c+" {to {stroke-dashoffset: "+D+";}}@-webkit-keyframes keyframe-dash-i"+c+" {to {stroke-dashoffset: "+D+";}}","init"!==d.type){for(z in b[u]){var G=b[u][z];G.animate({path:C},i.time.animate),-1!=a.inArray(u,v)?(G.node.setAttribute("stroke-width",i.strokeHighlightWidth),"0"===z?G.node.setAttribute("stroke",i.strokeHighlightColor):G.node.setAttribute("stroke",i.strokeHighlightDashColor)):"0"===z?(G.node.setAttribute("type","straight"),G.node.setAttribute("stroke-width",i.strokeWidth),G.node.setAttribute("stroke",i.strokeColor)):(G.node.setAttribute("type","dash"),G.node.setAttribute("stroke-width",i.strokeDashWidth),G.node.setAttribute("stroke",i.strokeDashColor))}try{b[u][1].node.setAttribute("style","animation: keyframe-dash-i"+c+" "+D/i.strokeSpeed*i.time.frame/100+"s linear infinite; -webkit-animation: keyframe-dash-i"+c+" "+D/500*30+"s linear infinite")}catch(A){}}if("undefined"==typeof b[u]){b[u]=[];var H=n.path(C);H.node.setAttribute("stroke-width",i.strokeWidth),H.node.setAttribute("stroke",i.strokeColor),H.node.setAttribute("match",u),b[u].push(H);var I=n.path(C);I.node.setAttribute("stroke-width",i.strokeDashWidth),I.node.setAttribute("stroke",i.strokeDashColor),I.node.setAttribute("stroke-dasharray",i.strokeDashWeight+", "+i.strokeDashMargin),I.node.setAttribute("class","anim-path"),I.node.setAttribute("style","animation: keyframe-dash-i"+c+" "+D/i.strokeSpeed*i.time.frame/100+"s linear infinite; webkit-animation: keyframe-dash-i"+c+" "+D/500*30+"s linear infinite"),I.node.setAttribute("match",u),b[u].push(I),-1!=a.inArray(u,v)&&(H.node.setAttribute("stroke-width",i.strokeHighlightWidth),I.node.setAttribute("stroke-width",i.strokeHighlightWidth),H.node.setAttribute("stroke",i.strokeHighlightColor),I.node.setAttribute("stroke",i.strokeHighlightDashColor));var J=e.data("modelview-m"),K=y.data("modelview-p");J="undefined"!=typeof J?J.toString().split(","):[],J.push(u),K="undefined"!=typeof K?K.toString().split(","):[],K.push(u),e.data("modelview-m",a.unique(J).join(",")),y.data("modelview-p",a.unique(K).join(","))}c++}}}),r.text(s)}catch(q){console.warn(q)}}).triggerHandler("init.hypermodelHandler"),"undefined"!=typeof a.fn.sortable&&(k.find(".hypermodel-column").each(s),k.find(".hypermodel-body").each(function(){var b=a(this);b.sortable({items:".hypermodel-item:not(.hypermodel-item-add)",change:q,out:r,containment:"parent",tolerance:"pointer",start:function(a,b){b.placeholder.height(b.item.height()),b.item.data("sortable-idx",b.item.index())},update:function(a,b){"function"==typeof i.update&&i.update.apply(this,Array.prototype.slice.call(arguments))}})}))});case"add":var t=0,u=1e3;return a('[id^="model-"]').each(function(){var b=a(this),c=parseInt(b.attr("id").replace(/[^\d]+/,""));b.hasClass("hypermodel-grid")?c>t&&(t=c):b.hasClass("hypermodel-item")&&c>u&&(u=c)}),t++,u++,h.triggerHandler("resize.hypermodelHandler"),this.each(function(){var b=a(this);"undefined"!=typeof a.fn.sortable&&b.parent().sortable({items:".hypermodel-grid",handle:".hypermodel-header",change:q,out:r,containment:"parent",tolerance:"intersect",axis:"y",scroll:!0,dropOnEmpty:!0,start:function(a,b){b.placeholder.height(b.item.height()),b.item.data("sortable-idx",b.item.index())},update:function(a,b){"function"==typeof i.update&&i.update.apply(this,Array.prototype.slice.call(arguments))}}).disableSelection(),b.hasClass("hypermodel-grid")?(b.attr("id",(b.attr("id")?b.attr("id")+" ":"")+"model-n"+t),t++):b.hasClass("hypermodel-item")&&(b.attr("id",(b.attr("id")?b.attr("id")+" ":"")+"model-n"+u),u++)});case"connect":return this.each(function(){var b=a(this);d.each(function(){var c=a(this),d=c.attr("id").replace(/.*model-[nc](\d+).*/,"$1"),e=b.data("target");e="undefined"!=typeof e&&null!==e&&""!==e?e.split(","):[],e.push(d),b.data("target",e.join(","))}),h.triggerHandler("resize.hypermodelHandler")});case"highlight":return this.each(function(){var b=a(this),c=b.data("highlight")?b.data("highlight"):"",e=[];if(c=""===c?[]:c.split(","),"undefined"==typeof d){var f=(b.data("target")?b.data("target"):"").toString(),g=f.split(",");for(var j in g){var k=g[j];c.push(k),e.push(k)}}else d.each(function(){var b=a(this),d=b.attr("id").replace(/.*model-[nc](\d+).*/,"$1");""!==d&&(c.push(d),e.push(d))});b.data("highlight",a.unique(c).join(",")),h.triggerHandler("resize.hypermodelHandler"),setTimeout(function(){var c=b.data("highlight")?b.data("highlight"):"";c=""===c?[]:c.split(",");for(var d in e){var f=e[d];-1!=a.inArray(f,c)&&c.splice(a.inArray(f,c),1)}b.data("highlight",a.unique(c).join(",")),h.triggerHandler("resize.hypermodelHandler")},i.time.highlight)});case"repaint":return h.triggerHandler("resize.hypermodelHandler"),this;case"remove":return this.each(function(){var c=a(this),d=[],e=c.data("modelview-m"),f=c.data("modelview-p");"undefined"!=typeof e&&null!==e&&(e=e.toString().split(","),d=d.concat(e)),"undefined"!=typeof f&&null!==f&&(f=f.toString().split(","),d=d.concat(f));for(var g in d){var h=d[g];for(var i in b[h])try{b[h][i].remove(),delete d[g]}catch(j){console.log(j)}delete b[h]}}),this.hypermodel("repaint")}}}(jQuery);