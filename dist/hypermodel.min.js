//================================================================================
// [hypermodel]
// version: 1.0.2
// update: 2016.07.19
//================================================================================

!function(a){var b=[],c=0;a.fn.hypermodel=function(d,e){var f="init",g=a(window);a(document);"object"!=typeof d&&(f=d,d=e);var h={grad:1.75,time:{animate:300,frame:3e3,highlight:3e3},update:null,strokeSpeed:500,strokeColor:"rgba(192, 192, 192, .6)",strokeHighlightColor:"rgba(200, 206, 255, .6)",strokeHighlightDashColor:"rgba(178, 192, 255, 1)",strokeDashColor:"rgba(192, 192, 192, .95)",strokeWidth:1,strokeHighlightWidth:1,strokeDashWidth:1,strokeDashWeight:8,strokeDashMargin:6};a.extend(h,d);var i={offset:{t:20,r:10,b:20,l:10,d:.5,g:1},placeholder:{size:600}},j=a(this).addClass("hypermodel-wrapper"),k=null,l=!0,m=null,n=function(a,b){return Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2))},o=function(){p.apply(this,Array.prototype.slice.call(arguments))},p=function(){g.triggerHandler("resize.hypermodelHandler")},q=function(b){var c=a(this);c.sortable({items:".hypermodel-grid",handle:".hypermodel-header",change:o,out:p,containment:"parent",start:function(a,b){b.placeholder.height(b.item.height()),b.item.data("sortable-idx",b.item.index())},update:function(a,b){"function"==typeof h.update&&h.update.apply(this,Array.prototype.slice.call(arguments))}})};switch(f){case"init":return b=[],this.each(function(){j.css("position","relative"),j.find(".hypermodel-column .hypermodel-grid").bind("click",function(b){b.stopPropagation();a(this)}).find(".hypermodel-item").bind("click",function(b){b.stopPropagation();a(this)}),g.unbind("resize.hypermodelHandler init.hypermodelHandler").bind("resize.hypermodelHandler init.hypermodelHandler",function(d){try{var e=0;j.find(".hypermodel-column").each(function(){var b=a(this);e+=b.outerWidth(!0)}),j.find(".hypermodel-area").outerWidth(parseInt(e+1));var f={t:j.offset().top,l:j.offset().left},g={t:parseInt(j.css("padding-top").replace(/[^\d]+/,"")||0),l:parseInt(j.css("padding-left").replace(/[^\d]+/,"")||0)},o=0,p=0;try{o=j.parent()[0].scrollWidth-2*g.l,p=j.parent()[0].scrollHeight-2*g.t}catch(q){return!1}"init"==d.type?(a(".hyper-model-canvas").remove(),m=Raphael(0,0,o,p),m.canvas.setAttribute("class","hyper-model-canvas"),k=a(m.canvas),a(m.canvas).appendTo(j).css({left:0+g.l,top:0+g.t})):k.attr({width:o,height:p});var r=a('<style class="hyper-model-anim"></style>');a(".hyper-model-anim").remove(),a("head").append(r);var s="";j.find(".hypermodel-grid, .hypermodel-item").unbind("click.hypermodelHandler").bind("click.hypermodelHandler",function(b){b.stopPropagation();a(this)}).each(function(){var e=a(this);if("undefined"==typeof e.data("target")||""===e.data("target"))return!0;var j={t:e.offset().top+i.offset.d-i.offset.g+i.offset.t-f.t-g.t,r:e.offset().left+e.outerWidth()+i.offset.d-i.offset.g-f.l-g.l,b:e.offset().top+e.outerHeight()+i.offset.d-i.offset.g-f.t-g.t,l:e.offset().left+i.offset.d-i.offset.g-f.l-g.l},k="",o=e.data("target").toString().split(","),p={x:0,y:0},q={x:0,y:0};"undefined"!=typeof e.attr("id")&&null!==e.attr("id")&&(k=e.attr("id").replace(/.*model-[nc](\d+).*/,"$1"),"undefined"!=typeof k&&""!==k&&(k=parseInt(k)));for(var r in o){var t=a.trim(o[r]),u=k+"->"+t,v=e.data("highlight")?e.data("highlight").split(","):"";for(var w in v){var x=v[w];v[w]=k+"->"+x}var y=a("#model-n"+t).filter(":visible").not(".ui-sortable-helper");if(y.length<=0||y.is(":hidden")||y.hasClass("ui-sortable-helper")){for(var z in b[u])try{b[u][z].remove()}catch(A){console.log(A)}delete b[u]}else{var B={t:y.offset().top+i.offset.d+i.offset.t-f.t-g.t,r:y.offset().left+y.outerWidth()+i.offset.d-f.l-g.l,b:y.offset().top+y.outerHeight()+i.offset.d-f.t-g.t,l:y.offset().left+i.offset.d-f.l-g.l};p.x=j.r,p.y=j.t,q.x=B.l,q.y=B.t;var C="",D=n(p,q);if(C+=" M "+j.r+" "+j.t,j.t!==B.t&&l===!0){var E=Math.abs(j.r-B.l)/(1*h.grad),F=Math.abs(j.t-B.t)/100;C+=" C "+(j.r+E)+" "+(j.t+F)+" "+(B.l-E)+" "+(B.t-F)+" "}else C+=" L ";if(C+=B.l+" "+B.t,s+="@keyframes keyframe-dash-i"+c+" {to {stroke-dashoffset: "+D+";}}@-webkit-keyframes keyframe-dash-i"+c+" {to {stroke-dashoffset: "+D+";}}","init"!==d.type){for(z in b[u]){var G=b[u][z];G.animate({path:C},h.time.animate),-1!=a.inArray(u,v)?(G.node.setAttribute("stroke-width",h.strokeHighlightWidth),0===z?G.node.setAttribute("stroke",h.strokeHighlightColor):G.node.setAttribute("stroke",h.strokeHighlightDashColor)):0===z?(G.node.setAttribute("stroke-width",h.strokeWidth),G.node.setAttribute("stroke",h.strokeColor)):(G.node.setAttribute("stroke-width",h.strokeDashWidth),G.node.setAttribute("stroke",h.strokeDashColor))}try{b[u][1].node.setAttribute("style","animation: keyframe-dash-i"+c+" "+D/h.strokeSpeed*h.time.frame/100+"s linear infinite; -webkit-animation: keyframe-dash-i"+c+" "+D/500*30+"s linear infinite")}catch(A){}}if("undefined"==typeof b[u]){b[u]=[];var H=m.path(C);H.node.setAttribute("stroke-width",h.strokeWidth),H.node.setAttribute("stroke",h.strokeColor),H.node.setAttribute("match",u),b[u].push(H);var I=m.path(C);I.node.setAttribute("stroke-width",h.strokeDashWidth),I.node.setAttribute("stroke",h.strokeDashColor),I.node.setAttribute("stroke-dasharray",h.strokeDashWeight+", "+h.strokeDashMargin),I.node.setAttribute("class","anim-path"),I.node.setAttribute("style","animation: keyframe-dash-i"+c+" "+D/h.strokeSpeed*h.time.frame/100+"s linear infinite; webkit-animation: keyframe-dash-i"+c+" "+D/500*30+"s linear infinite"),I.node.setAttribute("match",u),b[u].push(I),-1!=a.inArray(u,v)&&(H.node.setAttribute("stroke-width",h.strokeHighlightWidth),I.node.setAttribute("stroke-width",h.strokeHighlightWidth),H.node.setAttribute("stroke",h.strokeHighlightColor),I.node.setAttribute("stroke",h.strokeHighlightDashColor));var J=e.data("modelview-m"),K=y.data("modelview-p");J="undefined"!=typeof J?J.toString().split(","):[],J.push(u),K="undefined"!=typeof K?K.toString().split(","):[],K.push(u),e.data("modelview-m",a.unique(J).join(",")),y.data("modelview-p",a.unique(K).join(","))}c++}}}),r.text(s)}catch(q){console.warn(q)}}).triggerHandler("init.hypermodelHandler"),"undefined"!=typeof a.fn.sortable&&(j.find(".hypermodel-column").each(q),j.find(".hypermodel-body").each(function(){var b=a(this);b.sortable({items:".hypermodel-item:not(.hypermodel-item-add)",change:o,out:p,containment:"parent",start:function(a,b){b.placeholder.height(b.item.height()),b.item.data("sortable-idx",b.item.index())},update:function(a,b){"function"==typeof h.update&&h.update.apply(this,Array.prototype.slice.call(arguments))}})}))});case"add":var r=0,s=1e3;return a('[id^="model-"]').each(function(){var b=a(this),c=parseInt(b.attr("id").replace(/[^\d]+/,""));b.hasClass("hypermodel-grid")?c>r&&(r=c):b.hasClass("hypermodel-item")&&c>s&&(s=c)}),r++,s++,g.triggerHandler("resize.hypermodelHandler"),this.each(function(){var b=a(this);"undefined"!=typeof a.fn.sortable&&b.parent().sortable({items:".hypermodel-grid",handle:".hypermodel-header",change:o,out:p,containment:"parent",start:function(a,b){b.placeholder.height(b.item.height()),b.item.data("sortable-idx",b.item.index())},update:function(a,b){"function"==typeof h.update&&h.update.apply(this,Array.prototype.slice.call(arguments))}}),b.hasClass("hypermodel-grid")?(b.attr("id",(b.attr("id")?b.attr("id")+" ":"")+"model-n"+r),r++):b.hasClass("hypermodel-item")&&(b.attr("id",(b.attr("id")?b.attr("id")+" ":"")+"model-n"+s),s++)});case"connect":return this.each(function(){var b=a(this);d.each(function(){var c=a(this),d=c.attr("id").replace(/.*model-[nc](\d+).*/,"$1"),e=b.data("target");e="undefined"!=typeof e&&null!==e&&""!==e?e.split(","):[],e.push(d),b.data("target",e.join(","))}),g.triggerHandler("resize.hypermodelHandler")});case"highlight":return this.each(function(){var b=a(this),c=b.data("highlight")?b.data("highlight"):"",e=[];if(c=""===c?[]:c.split(","),"undefined"==typeof d){var f=(b.data("target")?b.data("target"):"").toString(),i=f.split(",");for(var j in i){var k=i[j];c.push(k),e.push(k)}}else d.each(function(){var b=a(this),d=b.attr("id").replace(/.*model-[nc](\d+).*/,"$1");""!==d&&(c.push(d),e.push(d))});b.data("highlight",a.unique(c).join(",")),g.triggerHandler("resize.hypermodelHandler"),setTimeout(function(){var c=b.data("highlight")?b.data("highlight"):"";c=""===c?[]:c.split(",");for(var d in e){var f=e[d];-1!=a.inArray(f,c)&&c.splice(a.inArray(f,c),1)}b.data("highlight",a.unique(c).join(",")),g.triggerHandler("resize.hypermodelHandler")},h.time.highlight)});case"repaint":return g.triggerHandler("resize.hypermodelHandler"),this;case"remove":return this.each(function(){var c=a(this),d=[],e=c.data("modelview-m"),f=c.data("modelview-p");"undefined"!=typeof e&&null!==e&&(e=e.toString().split(","),d=d.concat(e)),"undefined"!=typeof f&&null!==f&&(f=f.toString().split(","),d=d.concat(f));for(var g in d){var h=d[g];for(var i in b[h])try{b[h][i].remove(),delete d[g]}catch(j){console.log(j)}delete b[h]}}),this.hypermodel("repaint")}}}(jQuery);